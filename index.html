<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Who am I</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#051017; --panel:#0b1116; --accent:#00e2bd; --muted:#9aa7b3;
      --glow: 0 10px 40px rgba(0,226,189,0.08); --font: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:var(--font);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(0,226,189,0.03), transparent 8%),
        radial-gradient(1000px 500px at 90% 90%, rgba(0,132,255,0.02), transparent 6%),
        var(--bg);
      color:#d6e7ee; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; align-items:center; justify-content:center; padding:28px;
    }
    .card{
      width:100%; max-width:900px; border-radius:16px; padding:36px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      box-shadow:var(--glow); backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.03);
      display:grid; gap:22px; align-items:center;
    }
    .center{text-align:center}

    .who{
      font-size: clamp(36px, 9vw, 84px);
      font-weight:800; letter-spacing:0.02em; line-height:0.95;
      position:relative; display:inline-flex; align-items:flex-end;
      will-change: transform, text-shadow, filter;
    }

    /* النص المتغير */
    #whoText{
      position:relative; display:inline-block; white-space:nowrap;
    }
    /* طبقتين ألوان للجليتش (بتاخد النص من data-text) */
    #whoText::before, #whoText::after{
      content: attr(data-text);
      position:absolute; left:0; top:0; pointer-events:none; opacity:0;
      mix-blend-mode:screen;
      filter: blur(0.3px);
    }
    /* تتفعل وقت النبضة */
    #whoText.burst::before{
      color:#ff2a2a; opacity:.75; transform: translate(2.2px,-1.6px) skewX(0.6deg);
    }
    #whoText.burst::after{
      color:#2affff; opacity:.75; transform: translate(-2.2px,1.6px) skewY(-0.6deg);
    }

    /* مؤشر الكتابة: يومض أثناء وبعد الكتابة */
    .cursor{
      display:inline-block; width:6px; height:1.05em; background:var(--accent);
      margin-left:10px; border-radius:2px; transform: translateY(-2px);
      box-shadow: 0 0 12px rgba(0,226,189,0.8);
      /* نخليه يختفي/يظهر باستمرار فقط */
      animation: blink 0.9s steps(1,end) infinite;
    }
    @keyframes blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }

    /* اهتزاز أقوى مستمر بعد الكتابة */
    .wiggle{
      animation: floatShake 1.6s cubic-bezier(.34,.01,.27,.99) infinite;
      transform-origin: 50% 60%;
    }
    @keyframes floatShake{
      0%   { transform: translate(0,0) rotate(0) scale(1) }
      15%  { transform: translate(1.2px,-1.6px) rotate(-0.25deg) scale(1.002) }
      35%  { transform: translate(-1.6px,1.2px) rotate( 0.28deg) scale(0.998) }
      55%  { transform: translate(1.1px,0.8px) rotate(-0.22deg) scale(1.001) }
      75%  { transform: translate(-1px,-1.1px) rotate( 0.24deg) scale(0.999) }
      100% { transform: translate(0,0) rotate(0) scale(1) }
    }

    /* نبضة جليتش أقوى على النص نفسه */
    .glitch-burst{
      animation: glitchBurst 520ms steps(7) 1 both;
      filter: saturate(1.25) contrast(1.08);
    }
    @keyframes glitchBurst{
      0%   { transform: translate(0,0); text-shadow: none; }
      18%  { transform: translate(1.6px,-1.4px) skewX(0.4deg);
             text-shadow: 2.2px 0 rgba(255,0,0,.55), -2.2px 0 rgba(0,255,255,.55); }
      36%  { transform: translate(-2.2px,1.8px) skewY(-0.5deg);
             text-shadow: 3.2px 0 rgba(255,0,0,.5), -3.2px 0 rgba(0,255,255,.5); }
      62%  { transform: translate(1.4px,0.9px);
             text-shadow: 1.6px 0 rgba(255,0,0,.45), -1.6px 0 rgba(0,255,255,.45); }
      82%  { transform: translate(-1.2px,-1.2px);
             text-shadow: 2px 0 rgba(255,0,0,.4), -2px 0 rgba(0,255,255,.4); }
      100% { transform: translate(0,0); text-shadow: none; }
    }

    /* طبقة SVG القديمة تتحرك برضه */
    .who .glitch{
      position:absolute; inset:0; pointer-events:none; mix-blend-mode:screen; opacity:0;
      animation: glitchIn 0.9s 1 forwards;
    }
    @keyframes glitchIn{ 0%{opacity:0} 20%{opacity:1} 100%{opacity:0.22} }
    @keyframes g1 {
      0%{transform:translate(0,0)}
      20%{transform:translate(-3px,-2px)}
      40%{transform:translate(3px,2px)}
      60%{transform:translate(-2px,2px)}
      100%{transform:translate(0,0)}
    }

    .sub{ margin-top:8px; color:var(--muted); font-weight:500; letter-spacing:0.03em; }
    .info-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:14px; margin-top:12px; }
    .info{
      background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01));
      border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,0.02);
      min-height:72px; display:flex; flex-direction:column; justify-content:center;
      transition:transform .22s ease, box-shadow .22s ease;
    }
    .info:hover{ transform: translateY(-6px); box-shadow: 0 14px 40px rgba(0,0,0,0.45); }
    .label{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:0.12em; }
    .value{ font-size:16px; font-weight:700; margin-top:6px; color:#e9fbf6; word-break:break-word; }
    .footer{ text-align:center; color:var(--muted); font-size:13px; margin-top:6px; }

    @media (prefers-reduced-motion: reduce){
      .wiggle,.glitch-burst{ animation:none !important }
      #whoText::before,#whoText::after{ opacity:0 !important }
      .who .glitch{ animation:none !important; opacity:0.12 }
    }
    @media (max-width:520px){ .card{ padding:22px } .who{ font-size:36px } }
  </style>
</head>
<body>
  <main class="card center" role="main" aria-labelledby="who-title">
    <div style="position:relative;">
      <h1 id="who-title" class="who" aria-live="polite">
        <span class="typing" id="whoText" aria-hidden="true" data-text=""></span>
        <span class="cursor" id="cursor" aria-hidden="true"></span>
        <!-- glitch layer -->
        <svg class="glitch" width="100%" height="100%" viewBox="0 0 100 30" preserveAspectRatio="none" aria-hidden="true">
          <text x="50%" y="60%" text-anchor="middle" dominant-baseline="middle"
                style="font-size:14px; font-weight:800; font-family:var(--font); fill:rgba(0,226,189,0.22);">
            <tspan id="g1" style="mix-blend-mode:screen; filter: blur(0.6px);">Who am I</tspan>
          </text>
        </svg>
      </h1>
    </div>

    <div class="sub" id="subline" aria-hidden="true">A subtle echo of <code>whoami</code> — discover yourself</div>

    <div class="info-grid" id="infoGrid" aria-live="polite" aria-atomic="true">
      <div class="info"><div class="label">Device</div><div class="value" id="deviceVal">Detecting…</div></div>
      <div class="info"><div class="label">Browser</div><div class="value" id="browserVal">Detecting…</div></div>
      <div class="info"><div class="label">Operating System</div><div class="value" id="osVal">Detecting…</div></div>
      <div class="info"><div class="label">Public IP</div><div class="value" id="ipVal">Fetching…</div></div>
    </div>

    <div class="footer" id="footerNote">No tracking — client-side only.</div>
  </main>

  <script>
    function safeText(s){ return String(s || '').trim(); }

    function parseUserAgent(){
      const ua = navigator.userAgent || '';
      const platform = navigator.platform || '';
      const uaLow = ua.toLowerCase();
      const uaData = navigator.userAgentData || null;

      let deviceType = 'Desktop';
      const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
      if(/mobile|iphone|ipod|android|blackberry|iemobile|opera mini/.test(uaLow)) deviceType = 'Mobile';
      else if(/ipad|tablet/.test(uaLow)) deviceType = 'Tablet';
      else if(isTouch && (/macintel/.test(platform.toLowerCase()) || /linux/.test(platform.toLowerCase()))) deviceType = 'Tablet';

      let os = 'Unknown';
      if (uaLow.includes('android')) os = 'Android';
      else if (/\biphone\b/.test(uaLow) || /\bipod\b/.test(uaLow)) os = 'iOS';
      else if (/\bipad\b/.test(uaLow)) os = 'iPadOS';
      else if (/macintosh|mac os x/.test(uaLow)) {
        if (navigator.platform && /macintel/i.test(navigator.platform) && navigator.maxTouchPoints > 1) os = 'iPadOS';
        else os = 'macOS';
      } else if (/windows nt/.test(uaLow)) os = 'Windows';
      else if (/linux/.test(uaLow)) os = 'Linux';

      let browser = 'Unknown', version = '';
      if (/edg\//i.test(ua)) { browser = 'Edge'; version = (ua.match(/edg\/([\d\.]+)/i)||[])[1] || ''; }
      else if (/opr\/|opera/i.test(ua)) { browser = 'Opera'; version = (ua.match(/(?:opr|opera)[\/ ]([\d\.]+)/i)||[])[1] || ''; }
      else if (/crios/i.test(ua)) { browser = 'Chrome (iOS)'; version = (ua.match(/crios\/([\d\.]+)/i)||[])[1] || ''; }
      else if (/chrome\/|chromium\//i.test(ua) && !/mobile safari/i.test(ua)) { browser = 'Chrome'; version = (ua.match(/(?:chrome|chromium)\/([\d\.]+)/i)||[])[1] || ''; }
      else if (/fxios/i.test(ua)) { browser = 'Firefox (iOS)'; version = (ua.match(/fxios\/([\d\.]+)/i)||[])[1] || ''; }
      else if (/firefox\/|fxios/i.test(ua)) { browser = 'Firefox'; version = (ua.match(/firefox\/([\d\.]+)/i)||[])[1] || ''; }
      else if (/safari/i.test(ua) && !/crios|fxios|edg|opr|chrome|chromium/i.test(ua)) { browser = 'Safari'; version = (ua.match(/version\/([\d\.]+)/i)||[])[1] || ''; }
      else if (uaData && uaData.brands && uaData.brands.length){
        const brands = uaData.brands.map(b=>b.brand+' '+b.version).join(', ');
        browser = 'Browser ('+brands+')';
      }

      if ((/iphone|ipad|ipod/.test(uaLow)) && os !== 'iOS' && os !== 'iPadOS') {
        if (/iphone/.test(uaLow)) os = 'iOS'; else if (/ipad/.test(uaLow)) os = 'iPadOS';
      }
      if (/crios/i.test(uaLow)) { browser = 'Chrome (iOS)'; version = (ua.match(/crios\/([\d\.]+)/i)||[])[1] || version; }

      const browserLabel = browser + (version ? ' · ' + version : '');
      return { ua, platform, deviceType, browser: browserLabel, browserRaw: browser, os };
    }

    function setVal(id, txt){
      const el = document.getElementById(id);
      if(el) el.textContent = safeText(txt || 'Unknown');
    }

    /* نبضات جليتش متكررة */
    function startGlitchBursts(){
      const whoTextEl = document.getElementById('whoText');
      const svgTspan = document.getElementById('g1');

      function pulse(){
        if(whoTextEl){
          // شغّل burst على النص الأساسي + الطبقتين
          whoTextEl.classList.add('glitch-burst','burst');
          setTimeout(()=>{
            whoTextEl.classList.remove('glitch-burst','burst');
          }, 540);
        }
        if(svgTspan){
          svgTspan.style.animation = 'none'; void svgTspan.offsetWidth; // reflow
          svgTspan.style.animation = 'g1 0.7s linear 0s 1';
          svgTspan.style.transformOrigin = '50% 50%';
        }
        scheduleNext();
      }

      function scheduleNext(){
        const delay = 1800 + Math.random()*2200; // أسرع شوية
        setTimeout(pulse, delay);
      }

      scheduleNext();
    }

    /* كتابة + جليتش + اهتزاز + إبقاء المؤشر يومض دايمًا */
    async function runIntroSequence(onComplete){
      const whoTextEl = document.getElementById('whoText');
      const whoTitle  = document.getElementById('who-title');
      const phrase = "Who am I";

      whoTextEl.textContent = '';
      whoTextEl.setAttribute('data-text','');

      for(let i=0;i<=phrase.length;i++){
        const current = phrase.slice(0,i);
        whoTextEl.textContent = current;
        // مهم: نحدّث data-text عشان طبقات الجليتش تعرض نفس النص
        whoTextEl.setAttribute('data-text', current);
        await new Promise(r => setTimeout(r, 80 + Math.random()*55));
      }

      // فعّل طبقة SVG الخفيفة
      const g = document.querySelector('.who .glitch');
      if(g){ g.style.opacity = '0.22'; }

      // اهتزاز أقوى مستمر
      if(whoTitle){ whoTitle.classList.add('wiggle'); }

      // ابدأ نبضات الجليتش
      startGlitchBursts();

      if(typeof onComplete === 'function') onComplete();
    }

    async function fetchPublicIP(retries = 2, timeoutMs = 4000){
      const url = 'https://api.ipify.org?format=json';
      for(let attempt = 0; attempt <= retries; attempt++){
        try{
          const controller = new AbortController();
          const id = setTimeout(()=>controller.abort(), timeoutMs);
          const res = await fetch(url, { signal: controller.signal, cache:'no-store' });
          clearTimeout(id);
          if(!res.ok) throw new Error('bad response');
          const json = await res.json();
          if(json && json.ip) return json.ip;
        }catch(err){
          if(attempt === retries){
            try{
              const ctrl2 = new AbortController();
              const id2 = setTimeout(()=>ctrl2.abort(), timeoutMs);
              const r2 = await fetch('https://ipinfo.io/json', { signal: ctrl2.signal, cache:'no-store' });
              clearTimeout(id2);
              if(r2.ok){
                const j2 = await r2.json();
                if(j2 && j2.ip) return j2.ip;
              }
            }catch(e){}
            return 'Unavailable';
          }
          await new Promise(r => setTimeout(r, 420 + Math.random()*300));
        }
      }
      return 'Unavailable';
    }

    (async function main(){
      const detection = parseUserAgent();

      runIntroSequence(function(){
        setVal('deviceVal', detection.deviceType);
        setVal('browserVal', detection.browser);
        setVal('osVal', detection.os);
      });

      setVal('ipVal', 'Fetching…');
      const ip = await fetchPublicIP(2, 4500);
      setVal('ipVal', ip === 'Unavailable' ? 'Unavailable' : ip);

      const sub = document.getElementById('subline');
      if(sub) sub.setAttribute('aria-hidden','false');

      console.debug('whoami.nfc — detection:', { ua: navigator.userAgent, parsed: detection, ip });
    })();
  </script>
</body>
</html>
